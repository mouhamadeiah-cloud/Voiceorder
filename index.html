// ===========================================
// Speech Recognition - Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø©
// ===========================================
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'de-DE';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1; // Ù…Ù‡Ù…!
    
    recognition.onstart = function() {
        isRecording = true;
        micBtn.classList.add('recording');
        document.getElementById('recognizedText').innerHTML = 'ğŸ¤ HÃ¶re zu... Sprechen Sie jetzt';
        console.log('ğŸ¤ Recording started');
    };
    
    recognition.onspeechend = function() {
        console.log('ğŸ¤ Speech ended');
        // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‡Ù†Ø§ØŒ Ù†ØªØ±ÙƒÙ‡ ÙŠØ³ØªÙ…Ø±
    };
    
    recognition.onresult = function(event) {
        console.log('ğŸ¤ Result received:', event);
        
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = 0; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
                console.log('âœ… Final part:', transcript);
            } else {
                interimTranscript += transcript;
                console.log('â³ Interim:', transcript);
            }
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙˆØ±Ø§Ù‹
        if (interimTranscript) {
            document.getElementById('recognizedText').innerHTML = 
                `<span>ğŸ¤</span> "${interimTranscript}"<br><small>Sprechen Sie...</small>`;
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        if (finalTranscript) {
            console.log('ğŸ¤ Final complete:', finalTranscript);
            
            document.getElementById('recognizedText').innerHTML = 
                `<span>âœ…</span> "${finalTranscript}"<br><small>Verarbeite...</small>`;
            
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            setTimeout(() => {
                processOrderText(finalTranscript);
            }, 100);
        }
    };
    
    recognition.onerror = function(event) {
        console.error('âŒ Speech error:', event.error);
        
        let errorMessage = 'Fehler beim HÃ¶ren';
        if (event.error === 'no-speech') {
            errorMessage = 'Keine Sprache erkannt. Bitte versuchen Sie es nochmal.';
        } else if (event.error === 'audio-capture') {
            errorMessage = 'Mikrofon nicht gefunden.';
        } else if (event.error === 'not-allowed') {
            errorMessage = 'Mikrofon-Zugriff verweigert.';
        }
        
        document.getElementById('recognizedText').innerHTML = 
            `<span>âŒ</span> ${errorMessage}`;
        
        stopRecording();
    };
    
    recognition.onend = function() {
        console.log('ğŸ¤ Recognition ended');
        stopRecording();
    };
    
} else {
    document.getElementById('recognizedText').innerHTML = 
        '<span>âŒ</span> Ihr Browser unterstÃ¼tzt keine Spracheingabe';
}

function startRecording() {
    if (recognition && !isRecording) {
        try {
            recognition.start();
            console.log('ğŸ¤ Starting recording...');
        } catch (e) {
            console.error('Failed to start:', e);
            // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (e2) {
                    console.error('Failed again:', e2);
                }
            }, 500);
        }
    }
}

function stopRecording() {
    isRecording = false;
    micBtn.classList.remove('recording');
}
