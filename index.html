<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ KI Bestellassistent - Gast</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { margin: 0; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 16px;
            border-radius: 0 0 30px 30px;
            margin-bottom: 20px;
        }
        
        h1 { margin: 0; }
        
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #667eea;
            border: none;
            color: white;
            font-size: 48px;
            cursor: pointer;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .mic-button.recording {
            background: #e53e3e;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #667eea;
        }
        
        .order-items {
            background: white;
            border-radius: 20px;
            padding: 16px;
            margin: 20px 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .delete-btn {
            background: #feb2b2;
            color: #c53030;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .send-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 30px;
            font-size: 18px;
            width: 100%;
            cursor: pointer;
            margin-top: 16px;
        }
        
        .menu-section {
            background: white;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .menu-item {
            padding: 16px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üé§ KI Bestellassistent</h1>
            <div>Sagen Sie einfach was Sie m√∂chten</div>
        </div>
    </div>
    
    <div class="container">
        <!-- Voice Button -->
        <div style="text-align: center;">
            <button class="mic-button" id="micBtn">üé§</button>
            <div class="status" id="status">Bereit zum Zuh√∂ren</div>
        </div>
        
        <!-- Current Order -->
        <div class="order-items" id="orderSection" style="display: none;">
            <h3>üìã Ihre Bestellung</h3>
            <div id="orderList"></div>
            <div>Gesamt: <span id="totalItems">0</span> Artikel</div>
            <button class="send-btn" id="sendOrderBtn">‚úÖ Bestellung aufgeben</button>
        </div>
        
        <!-- Menu -->
        <div id="menuContainer">Men√º wird geladen...</div>
    </div>

    <!-- Firebase & Gemini -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.min.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBixb8qkMJuJLWkCMHjJYeAMR9mu_qDSEk",
            authDomain: "restaurantsysteme-eaff6.firebaseapp.com",
            projectId: "restaurantsysteme-eaff6",
            storageBucket: "restaurantsysteme-eaff6.firebasestorage.app",
            messagingSenderId: "891911663005",
            appId: "1:891911663005:web:85672b40c90c158c2ad374"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Gemini Key
        const GEMINI_API_KEY = "AIzaSyDFetuGDsBvIUmJ-RU-yrr9CwtFRQO4KTU";  // <-- DEIN KEY
        
        let menuItems = [];
        let currentOrder = [];
        let mediaRecorder = null;
        let audioChunks = [];
        
        // ===========================================
        // Load Menu
        // ===========================================
        async function loadMenu() {
            const snapshot = await db.collection('items').where('active', '==', true).get();
            menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            displayMenu();
        }
        
        function displayMenu() {
            const container = document.getElementById('menuContainer');
            let html = '<div class="menu-section"><h3>üçΩÔ∏è Speisekarte</h3>';
            
            menuItems.forEach(item => {
                html += `
                    <div class="menu-item">
                        <div>
                            <strong>${item.displayName || item.name}</strong><br>
                            ‚Ç¨${(item.price || 0).toFixed(2)}
                        </div>
                        <button class="add-btn" onclick="addToOrder('${item.id}')">+</button>
                    </div>
                `;
            });
            
            container.innerHTML = html + '</div>';
        }
        
        // ===========================================
        // Audio Recording & Gemini
        // ===========================================
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    document.getElementById('status').innerHTML = 'üé§ KI h√∂rt zu...';
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendToGemini(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('status').innerHTML = 'üé§ Sprechen Sie jetzt...';
                
                // Automatisch nach 5 Sekunden stoppen
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Mikrofon Fehler:', error);
                document.getElementById('status').innerHTML = '‚ùå Mikrofon nicht verf√ºgbar';
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('micBtn').classList.remove('recording');
            }
        }
        
        async function sendToGemini(audioBlob) {
            try {
                // Konvertiere Audio zu Base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = async function() {
                    const base64Audio = reader.result.split(',')[1];
                    
                    // Erstelle die Liste der Gerichte
                    const menuList = menuItems.map(item => 
                        `- ${item.displayName || item.name}`
                    ).join('\n');
                    
                    // Prompt f√ºr Gemini
                    const prompt = `
Du bist ein Kellner. Der Gast spricht mit dir.
H√∂re genau zu und verstehe was er bestellen m√∂chte.

Verf√ºgbare Gerichte:
${menuList}

Antworte NUR mit einem JSON-Array:
[{"gericht": "GENAUER NAME", "menge": ZAHL}]

Beispiel: F√ºr "zweimal Pizza" -> [{"gericht": "Pizza", "menge": 2}]
`;
                    
                    // Sende Audio an Gemini
                    const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    
                    const result = await model.generateContent([
                        prompt,
                        {
                            inlineData: {
                                mimeType: "audio/webm",
                                data: base64Audio
                            }
                        }
                    ]);
                    
                    const response = await result.response;
                    const text = response.text();
                    const cleanJson = text.replace(/```json|```/g, '').trim();
                    const items = JSON.parse(cleanJson);
                    
                    // Zur Bestellung hinzuf√ºgen
                    items.forEach(item => {
                        const menuItem = menuItems.find(m => 
                            (m.displayName || m.name).toLowerCase().includes(item.gericht.toLowerCase())
                        );
                        
                        if (menuItem) {
                            for (let i = 0; i < (item.menge || 1); i++) {
                                addToOrder(menuItem.id, menuItem.displayName || menuItem.name);
                            }
                        }
                    });
                    
                    document.getElementById('status').innerHTML = '‚úÖ Verstanden!';
                    
                    if (items.length === 0) {
                        document.getElementById('status').innerHTML = '‚ùì Nichts verstanden';
                    }
                };
                
            } catch (error) {
                console.error('Gemini Fehler:', error);
                document.getElementById('status').innerHTML = '‚ùå Fehler bei der Verarbeitung';
            }
        }
        
        // ===========================================
        // Order Management
        // ===========================================
        function addToOrder(itemId, itemName) {
            if (!itemName) {
                const item = menuItems.find(i => i.id === itemId);
                itemName = item.displayName || item.name;
            }
            
            currentOrder.push({
                id: itemId,
                name: itemName,
                orderId: Date.now() + Math.random()
            });
            
            updateOrderDisplay();
        }
        
        function removeFromOrder(index) {
            currentOrder.splice(index, 1);
            updateOrderDisplay();
        }
        
        function updateOrderDisplay() {
            const section = document.getElementById('orderSection');
            const list = document.getElementById('orderList');
            const total = document.getElementById('totalItems');
            
            if (currentOrder.length > 0) {
                section.style.display = 'block';
                
                let html = '';
                currentOrder.forEach((item, i) => {
                    html += `
                        <div class="order-item">
                            <span>${item.name}</span>
                            <button class="delete-btn" onclick="removeFromOrder(${i})">‚úï</button>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
                total.textContent = currentOrder.length;
            } else {
                section.style.display = 'none';
            }
        }
        
        async function sendOrder() {
            if (currentOrder.length === 0) return;
            
            const grouped = {};
            currentOrder.forEach(item => {
                if (!grouped[item.id]) {
                    grouped[item.id] = { name: item.name, quantity: 1 };
                } else {
                    grouped[item.id].quantity += 1;
                }
            });
            
            await db.collection('orders').add({
                items: Object.values(grouped),
                tableNumber: 1,
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                orderNumber: Math.floor(Math.random() * 9000) + 1000
            });
            
            currentOrder = [];
            updateOrderDisplay();
            alert('Bestellung aufgegeben!');
        }
        
        // ===========================================
        // Event Listeners
        // ===========================================
        document.getElementById('micBtn').addEventListener('mousedown', startRecording);
        document.getElementById('micBtn').addEventListener('mouseup', stopRecording);
        document.getElementById('micBtn').addEventListener('mouseleave', stopRecording);
        document.getElementById('sendOrderBtn').addEventListener('click', sendOrder);
        
        // Global functions
        window.addToOrder = addToOrder;
        window.removeFromOrder = removeFromOrder;
        
        // Start
        loadMenu();
    </script>
</body>
</html>
